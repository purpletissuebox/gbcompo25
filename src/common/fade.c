#include <gb/cgb.h>
#include "common.h"
#include "actor.h"

u16 fadeAmt = 0;
u8 activeColors[32][3];
const u8 fadeLUT[32][32] = {
	{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},
	{ 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2},
	{ 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3},
	{ 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4},
	{ 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5},
	{ 0, 0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6},
	{ 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7},
	{ 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8},
	{ 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 8, 8, 8, 8, 9, 9},
	{ 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9,10,10},
	{ 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 9, 9, 9,10,10,10,11,11},
	{ 0, 0, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 7, 8, 8, 9, 9, 9,10,10,10,11,11,12,12},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 8, 9, 9,10,10,10,11,11,12,12,13,13},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 9,10,10,11,11,12,12,13,13,14,14},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,13,13,14,14,15,15},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,13,13,14,14,15,15,16},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7, 7, 8, 8, 9, 9,10,10,11,12,12,13,13,14,14,15,15,16,16,17},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 5, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,12,12,13,13,14,15,15,16,16,17,17,18},
	{ 0, 1, 1, 2, 2, 3, 4, 4, 5, 6, 6, 7, 7, 8, 9, 9,10,10,11,12,12,13,13,14,15,15,16,17,17,18,18,19},
	{ 0, 1, 1, 2, 3, 3, 4, 5, 5, 6, 6, 7, 8, 8, 9,10,10,11,12,12,13,14,14,15,15,16,17,17,18,19,19,20},
	{ 0, 1, 1, 2, 3, 3, 4, 5, 5, 6, 7, 7, 8, 9, 9,10,11,12,12,13,14,14,15,16,16,17,18,18,19,20,20,21},
	{ 0, 1, 1, 2, 3, 4, 4, 5, 6, 6, 7, 8, 9, 9,10,11,11,12,13,13,14,15,16,16,17,18,18,19,20,21,21,22},
	{ 0, 1, 1, 2, 3, 4, 4, 5, 6, 7, 7, 8, 9,10,10,11,12,13,13,14,15,16,16,17,18,19,19,20,21,22,22,23},
	{ 0, 1, 2, 2, 3, 4, 5, 5, 6, 7, 8, 9, 9,10,11,12,12,13,14,15,15,16,17,18,19,19,20,21,22,22,23,24},
	{ 0, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 9,10,10,11,12,13,14,15,15,16,17,18,19,19,20,21,22,23,23,24,25},
	{ 0, 1, 2, 3, 3, 4, 5, 6, 7, 8, 8, 9,10,11,12,13,13,14,15,16,17,18,18,19,20,21,22,23,23,24,25,26},
	{ 0, 1, 2, 3, 3, 4, 5, 6, 7, 8, 9,10,10,11,12,13,14,15,16,17,17,18,19,20,21,22,23,24,24,25,26,27},
	{ 0, 1, 2, 3, 4, 5, 5, 6, 7, 8, 9,10,11,12,13,14,14,15,16,17,18,19,20,21,22,23,23,24,25,26,27,28},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,22,23,24,25,26,27,28,29},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31},
};

void loadColors(u16 *colors, u8 palette, u8 N)
{
	u8 *p = activeColors[palette];

	do
	{
		*p++ = (*colors & 0x001F) >> 0;
		*p++ = (*colors & 0x03E0) >> 5;
		*p++ = (*colors & 0x7C00) >> 10;
		colors++;
	} while (--N);
}

void updateScreenColors(u8 fade_amt)
{
	u16 colorBuf[8][4]; //this will kill our stack lol
	u8 *p = activeColors[0];
	u16 *c = colorBuf[0];
	u8 const * row = fadeLUT[fade_amt];
	u8 N = 4;

	do
	{
		*c  = (row[*p++]);
		*c |= (row[*p++]) << 5;
		*c |= (row[*p++]) << 10;
		c++;
	} while (--N);

	set_bkg_palette(0, 1, colorBuf[0]);
}

u8 tickFade(u16 speed)
{
	u8 result = 0;
	fadeAmt += speed;

	if (fadeAmt & 0x8000)
	{
		result = 1;
		fadeAmt = 0x0000;
	}
	if (fadeAmt > 0x1F00)
	{
		result = 1;
		fadeAmt = 0x1F00;
	}
	updateScreenColors(fadeAmt >> 8);
	return result;
}

void fadeScreen(Actor *self)
{
	if (tickFade(self->variable))
		removeActor(self);
}