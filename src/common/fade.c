#pragma bank 255

#include <gb/cgb.h>
#include "common.h"
#include "actor.h"

BANKREF(fadeScreen_bank)

const u8 fade_LUT[32][32] = {
	{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},
	{ 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2},
	{ 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3},
	{ 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4},
	{ 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5},
	{ 0, 0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6},
	{ 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7},
	{ 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8},
	{ 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 8, 8, 8, 8, 9, 9},
	{ 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9,10,10},
	{ 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 9, 9, 9,10,10,10,11,11},
	{ 0, 0, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 7, 8, 8, 9, 9, 9,10,10,10,11,11,12,12},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 8, 9, 9,10,10,10,11,11,12,12,13,13},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 9,10,10,11,11,12,12,13,13,14,14},
	{ 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,13,13,14,14,15,15},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9,10,10,11,11,12,12,13,13,14,14,15,15,16},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7, 7, 8, 8, 9, 9,10,10,11,12,12,13,13,14,14,15,15,16,16,17},
	{ 0, 1, 1, 2, 2, 3, 3, 4, 5, 5, 6, 6, 7, 8, 8, 9, 9,10,10,11,12,12,13,13,14,15,15,16,16,17,17,18},
	{ 0, 1, 1, 2, 2, 3, 4, 4, 5, 6, 6, 7, 7, 8, 9, 9,10,10,11,12,12,13,13,14,15,15,16,17,17,18,18,19},
	{ 0, 1, 1, 2, 3, 3, 4, 5, 5, 6, 6, 7, 8, 8, 9,10,10,11,12,12,13,14,14,15,15,16,17,17,18,19,19,20},
	{ 0, 1, 1, 2, 3, 3, 4, 5, 5, 6, 7, 7, 8, 9, 9,10,11,12,12,13,14,14,15,16,16,17,18,18,19,20,20,21},
	{ 0, 1, 1, 2, 3, 4, 4, 5, 6, 6, 7, 8, 9, 9,10,11,11,12,13,13,14,15,16,16,17,18,18,19,20,21,21,22},
	{ 0, 1, 1, 2, 3, 4, 4, 5, 6, 7, 7, 8, 9,10,10,11,12,13,13,14,15,16,16,17,18,19,19,20,21,22,22,23},
	{ 0, 1, 2, 2, 3, 4, 5, 5, 6, 7, 8, 9, 9,10,11,12,12,13,14,15,15,16,17,18,19,19,20,21,22,22,23,24},
	{ 0, 1, 2, 2, 3, 4, 5, 6, 6, 7, 8, 9,10,10,11,12,13,14,15,15,16,17,18,19,19,20,21,22,23,23,24,25},
	{ 0, 1, 2, 3, 3, 4, 5, 6, 7, 8, 8, 9,10,11,12,13,13,14,15,16,17,18,18,19,20,21,22,23,23,24,25,26},
	{ 0, 1, 2, 3, 3, 4, 5, 6, 7, 8, 9,10,10,11,12,13,14,15,16,17,17,18,19,20,21,22,23,24,24,25,26,27},
	{ 0, 1, 2, 3, 4, 5, 5, 6, 7, 8, 9,10,11,12,13,14,14,15,16,17,18,19,20,21,22,23,23,24,25,26,27,28},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,22,23,24,25,26,27,28,29},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30},
	{ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31},
};

u16 fadeAmt = 0;
u8 activeColors[32][3];
u16 colorBuf[8][4];
const palette_color_t color_table[][32] = {
	{ RGB(6,13,10), RGB(28,31,26), RGB(17,24,14), RGB(1,3,4) },
};

void loadColors(u16 *colors) __naked
{
	colors;
	__asm
		ld hl, #_activeColors
		ld b, #32
		LOADCOLORS_ASM_LOOP:
			ld a, (de)
			inc de
			ld c, a
			and #31
			ld (hl+), a

			ld a, (de)
			rl c
			adc a
			rl c
			adc a
			rl c
			adc a
			and #31
			ld (hl+), a

			ld a, (de)
			inc de
			rra
			rra
			and #31
			ld (hl+), a

			dec b
		jr nz, LOADCOLORS_ASM_LOOP
		ret
	__endasm;
}

void updateScreenColors(u8 fade_amt)
{
	fade_amt;
	__asm
		add a
		add a
		add a
		ld b, #0
		add a
		rl b
		add a
		rl b
		add #<(_fade_LUT)
		ld c, a
		ld a, b
		adc #>(_fade_LUT)
		ld b, a

		ld hl, #_activeColors
		ld de, #_colorBuf

		UPDATESCREENCOLORS_ASM_LOOP :
			push de

			push bc
			ld a, (hl+)
			add c
			ld c, a
			adc b
			sub c
			ld b, a
			ld a, (bc)
			ld e, a
			pop bc

			push bc
			ld a, (hl+)
			add c
			ld c, a
			adc b
			sub c
			ld b, a
			ld a, (bc)
			rrca
			rrca
			rrca
			ld d, a
			pop bc

			push bc
			ld a, (hl+)
			add c
			ld c, a
			adc b
			sub c
			ld b, a
			ld a, (bc)
			pop bc

			add a
			add a
			xor d
			and #252
			xor d
			ldh (_scratch), a
			ld a, d
			and #224
			or e
			pop de
			ld (de), a
			inc de
			ldh a, (_scratch)
			ld (de), a
			inc de

			ld a, e
			sub #<(_colorBuf + 64)
		jr nz, UPDATESCREENCOLORS_ASM_LOOP
	__endasm;

	set_bkg_palette(0, 8, colorBuf[0]);
}

u8 tickFade(u16 speed)
{
	fadeAmt += speed;
	updateScreenColors(fadeAmt >> 8);
	return (fadeAmt >= 0x1F00);
}

void colorActor(Actor *self)
{
	u8 colorID = self->variable >> 8;
	u8 speed = self->variable & 0xFF;
	loadColors(color_table[colorID]);

	if ((speed+1) < 2)
	{
		updateScreenColors(speed? 0x1F : 0);
		removeActor(self);
		return;
	}

	fadeAmt = 0x00FF;
	if (speed & 0x80)
	{
		speed ^= 0xFF;
		fadeAmt = 0x1F00;
	}

	if (speed < 0x40)
		self->variable =    32 + (speed >> 1);
	else if (speed < 0x60)
		self->variable =   -64 + (speed << 1);
	else if (speed < 0x70)
		self->variable =  -634 + (speed << 3);
	else
		self->variable = -3322 + (speed << 5);

	if (speed & 0x80)
	{
		self->variable ^= 0xFFFF;
		self->variable += 1;
	}
}

void fadeScreen(Actor *self)
{
	if (tickFade(self->variable))
		removeActor(self);
}